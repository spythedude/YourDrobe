# Preseed configuration for Debian Installation
# WARNING: THIS CONFIGURATION WILL ERASE THE TARGET DISK (/dev/vda by default)
# IF A GUIDED "USE ENTIRE DISK" OPTION IS CHOSEN AND CONFIRMED.
# Passwords are set to "changeme" as requested. Change them for production systems.

#-------------------------------------------------------------------------------
# Localization
#-------------------------------------------------------------------------------
d-i debian-installer/locale string en_GB.UTF-8
d-i console-setup/ask_detect boolean false
d-i keyboard-configuration/xkb-keymap select gb

#-------------------------------------------------------------------------------
# Network configuration
#-------------------------------------------------------------------------------
# Assuming DHCP for network configuration. If static IP is needed, configure here.
# d-i netcfg/disable_dhcp boolean false
# d-i netcfg/get_hostname string unassigned
# d-i netcfg/get_domain string unassigned

# Mirror settings - choose a mirror close to you or use defaults
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

#-------------------------------------------------------------------------------
# Clock and time zone setup
#-------------------------------------------------------------------------------
d-i clock-setup/utc boolean true
d-i time/zone string Europe/London
d-i clock-setup/ntp boolean true

#-------------------------------------------------------------------------------
# User setup
#-------------------------------------------------------------------------------
# Root password
d-i passwd/root-password password changeme
d-i passwd/root-password-again password changeme
# For crypted passwords, use:
# d-i passwd/root-password-crypted password <crypted_hash_here>

# Regular user account
d-i passwd/make-user boolean true
d-i passwd/user-fullname string Debian User
d-i passwd/username string user
d-i passwd/user-password password changeme
d-i passwd/user-password-again password changeme
# For crypted passwords, use:
# d-i passwd/user-password-crypted password <crypted_hash_here>
d-i user-setup/allow-password-weak boolean true # Required for simple passwords like "changeme"
d-i passwd/user-default-groups string adm cdrom sudo dip plugdev lpadmin sambashare users

#-------------------------------------------------------------------------------
# Partitioning
# This section is configured to guide towards LVM on LUKS,
# prompting the user to select from standard guided partitioning options.
#-------------------------------------------------------------------------------
# Select the disk to partition.
d-i partman-auto/disk string /dev/vda

# Clear existing LVM, MD, and labels before presenting guided options.
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-partitioning/confirm_write_new_label boolean true

# Set the desired partitioning method to crypto (for LUKS).
# The installer should then prompt for a specific guided recipe using this method
# (e.g., "Guided - use entire disk and set up encrypted LVM").
d-i partman-auto/method string crypto

# If an LVM option is chosen from the guided menu, use all available space in the crypto container.
d-i partman-auto-lvm/guided_size string max
# Note: The swap size (e.g., 2GB) will be determined by the chosen guided recipe's defaults
# or may need to be adjusted if the chosen guided option allows it.
# Explicitly setting LVM LV sizes here would require an expert_recipe.

# Encryption passphrase settings (will be used if LUKS is configured via a guided option).
d-i partman-crypto/passphrase password changeme
d-i partman-crypto/passphrase-again password changeme
d-i partman-crypto/weak_passphrase boolean true # Allow weak passphrase "changeme"

# Confirmation settings to ensure user is prompted:
# Do not automatically confirm overwriting partitions on the disk.
# This should allow the guided menu to appear and ask for confirmation.
d-i partman/confirm_nooverwrite boolean false
# Do not automatically confirm all partman actions; allow user to review and confirm choices.
d-i partman/confirm boolean true

# Ensure that no specific recipe or finish action is pre-selected,
# so the installer prompts for a choice from the default guided options.
# Lines like partman-auto/choose_recipe, partman-auto/expert_recipe,
# and partman/choose_partition select finish are intentionally omitted or commented.

#-------------------------------------------------------------------------------
# Package selection
#-------------------------------------------------------------------------------
tasksel tasksel/first multiselect standard, ssh-server
# You can add other tasks like "desktop", "web-server", etc.
# Example: tasksel tasksel/first multiselect standard, ssh-server, desktop, gnome-desktop

# Additional packages to install.
# sudo and console-common are requested. openssh-server is for sshd_config modification.
d-i pkgsel/include string sudo console-common openssh-server
d-i pkgsel/upgrade select full-upgrade # Or safe-upgrade
d-i pkgsel/update-policy select unattended-upgrades # Or unattended-upgrades

# Optionally, remove packages you don't need.
d-i pkgsel/exclude string qemu-guest-agent
#-------------------------------------------------------------------------------
# Boot loader installation (GRUB)
#-------------------------------------------------------------------------------
# The installer will prompt for the GRUB installation location.
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
# The following line is commented out to prompt for boot device:
d-i grub-installer/setup_linux_firmware boolean
d-i grub-installer/bootdev string /dev/vda

#-------------------------------------------------------------------------------
# Finishing up the installation
#-------------------------------------------------------------------------------
# Late command to modify sshd_config to permit root login.
# This runs chrooted into the new system before the final reboot.
d-i preseed/late_command string \
    in-target sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config; \
    if ! grep -q "^PermitRootLogin yes" /target/etc/ssh/sshd_config; then \
        echo "PermitRootLogin yes" >> /target/etc/ssh/sshd_config; \
    fi; \
    in-target systemctl enable ssh # Ensure ssh service is enabled

# Do not automatically reboot. Halt the system instead.
# d-i finish-install/reboot_in_progress note
d-i debian-installer/exit/halt boolean false

#-------------------------------------------------------------------------------
# Finishing up the installation
#-------------------------------------------------------------------------------
# Late command to modify sshd_config to permit root login.
# This runs chrooted into the new system before the final reboot.
d-i preseed/late_command string \
    in-target sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config; \
    if ! grep -q "^PermitRootLogin yes" /target/etc/ssh/sshd_config; then \
        echo "PermitRootLogin yes" >> /target/etc/ssh/sshd_config; \
    fi; \
    in-target systemctl enable ssh # Ensure ssh service is enabled

# Automatically reboot after installation.
d-i finish-install/reboot_in_progress note
# To halt instead of reboot:
# d-i debian-installer/exit/halt boolean true
